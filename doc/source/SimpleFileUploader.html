<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.require([
  'Ext.container.Container',
  'Ext.layout.container.VBox',
  'Cs.file.data.FileUploader',
  'Cs.file.data.FileManager',
  'Cs.file.ui.FileItem',
]);

<span id='Cs-file-ui-SimpleFileUploader'>/**
</span>A simple UI for file uploading that shows a &quot;Browse&quot; button. Will also
allow file(s) to be dropped on the container.
*/
Ext.define('Cs.file.ui.SimpleFileUploader', {
  extend: 'Ext.container.Container',
  config: {
<span id='Cs-file-ui-SimpleFileUploader-cfg-url'>/**
</span>@cfg {String} url

The URL that files will be uploaded to. Required.
*/
    url: undefined,
<span id='Cs-file-ui-SimpleFileUploader-cfg-uploadWith'>/**
</span>@cfg {Function} uploadWith

A function to prepare requests before a given file is uploaded. Will
be given to the internal {@link Cs.file.data.FileUploader} instance
and must have the same signature as specified for that object's {@link
Cs.file.data.FileUploader#uploadWith} method.

If not given, then this object will use the 
{@link Cs.file.data.FileUploader#upload} method.
*/
    uploadWith: undefined,
<span id='Cs-file-ui-SimpleFileUploader-cfg-itemConfig'>/**
</span>@cfg {Object} itemConfig

A config to apply to each {@link Cs.file.ui.FileItem} component created
by this component.
*/
    itemConfig: undefined
  },
  alias: 'widget.simplefileuploader',
<span id='Cs-file-ui-SimpleFileUploader-method-constructor'>/**
</span>Create a new instance of this object.

@param {Object} config The config to apply to this component. A `vbox` layout
will always be used, but otherwise any config can be given.
*/
  constructor: function(config) {
    config = Ext.apply(config, { 
      layout: Ext.create('Ext.layout.container.Anchor')
    });

    this.initConfig(config);
    this.callParent(arguments);
  },
  initComponent: function () {
    var me = this,
    fileMap = {},
    uploadCmp,
    uploadCmpDef = {
      xtype: 'container',
      height: 28,
      anchor: &quot;100%&quot;,
      padding: &quot;3 0 0 0&quot;,
      layout: {type: 'hbox', pack: 'end' },
      itemId: &quot;upload&quot;,
      items: {
        xtype: 'button',
        text: 'Upload',
        height: 25,
        listeners: {
          click: function () {
            if(me.getUploadWith())
              uploader.uploadWith(me.getUploadWith());
            else
              uploader.upload();
          }
        }
      },
      hidden: true
    },
    listCmp,
    fileMgr = Ext.create('Cs.file.data.FileManager'),
    uploader,
    uploaderDef = { url: me.getUrl() };

    this.callParent(arguments);

    fileMgr.on('fileadded', function(record) {
      var item = Ext.create('Cs.file.ui.FileItem', record.get('name'), record.get('size'), 
                            me.getItemConfig() ||
                            { height: 25, 
                              style: { 'padding-top': 1, 'padding-bottom': 1 }
                            });

      fileMap[record.get('name')] = item;

      item.on('remove', function () {
        var hasDirtyFile = false;

        fileMgr.removeFile(record);
        uploader.abort(record);

        listCmp.remove(item);
        delete fileMap[record.get('name')];

        fileMgr.each(function (file) { 
          return ! (hasDirtyFile = file.dirty);
        });

        if(! hasDirtyFile)
          uploadCmp.setVisible(false);

      });

      uploadCmp.setVisible(true);
      listCmp.add(item);
    });

    if(Cs.file.data.FileManager.supportsFile) {
      uploaderDef = Ext.apply(uploaderDef, {
        progress: function(file, total, amt, evt) { 
          var item = fileMap[file.get('name')];
          if(item) {
            item.setProgress(amt);
          }
        }});
    }

    uploader = Ext.create('Cs.file.data.FileUploader', fileMgr, Ext.apply(uploaderDef, { 
      success: function(file, response, options) { 
        var item = fileMap[file.get('name')];
        if(item) {
          item.setStatus(true);
          delete fileMap[file.get('name')];
        }
      },
      failure: function(file, response, options) {
        var item = fileMap[file.get('name')];
        if(item) {
          item.setStatus(false);
          delete fileMap[file.get('name')];
        }
      }}));

    this.on('afterrender', function(c, opt) {
      var myEl = me.getEl(),
      msgCmp,
      fileCmp,
      fileCmpDef = {
        xtype: 'filefield',
        anchor: &quot;100%&quot;,
        height: 30,
        buttonText: &quot;Add a File ... &quot;,
        multiple: true,
        itemId: 'filepicker',
        listeners: {
          change: function(field, value, opt) {
            if(Cs.file.data.FileManager.supportsFile) 
              Ext.Array.each(field.fileInputEl.dom.files, fileMgr.addFile, fileMgr);
            else 
              fileMgr.addFile(field);

            fileCmp.setVisible(false);
            fileCmp = me.insert(0, fileCmpDef);
          }
        }
      };

      fileCmp = me.add(fileCmpDef);

      if(Cs.file.data.FileManager.supportsFile) {
        msgCmp = me.add({
          xtype: 'container',
          cls: 'droppable-region',
          html: &quot;Drop Files Here&quot;,
          width: '100%',
          height: 25,
          itemId: 'dropMsg',
          hidden: true
        });

        myEl.dom.addEventListener(&quot;dragenter&quot;, function (evt) {
          if(! msgCmp.isVisible()) {
            msgCmp.setVisible(true);
            msgCmp.updateBox(fileCmp.getBox(true));
            fileCmp.setVisible(false);
          }

          return false;
        }, false);

        myEl.dom.addEventListener(&quot;dragover&quot;, function (evt) {
          evt.stopPropagation();
          evt.preventDefault();

          return false;
        }, false);

        myEl.dom.addEventListener(&quot;drop&quot;, function (evt) {
          
          evt.stopPropagation();
          evt.preventDefault(); 
          
          fileCmp.setVisible(true);
          msgCmp.setVisible(false);

          Ext.Array.each(evt.dataTransfer.files, function(file) { 
            fileMgr.addFile(file);
          });

        }, false);
      }

      me.add([{
        xtype: 'container',
        flex: 1,
        layout: 'anchor',
        autoScroll: true,
        itemId: &quot;filelist&quot;
      }, uploadCmpDef]);

      listCmp = me.child(&quot;#filelist&quot;);
      uploadCmp = me.child(&quot;#upload&quot;);

    });
  }
});</pre>
</body>
</html>
